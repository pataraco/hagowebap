---
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Creates an AWS IAM managed policy for CodePipeline service'


Parameters:

  Environment:
    Description: 'Name of Environment'
    Type: String

  Project:
    Description: 'Name of the project being deployed'
    Type: String


Resources:

  IamManagedPolicyCodePipeline:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: !Sub 'Policy used for trust relationship with CodePipeline for ${Project}-${Environment}'
      ManagedPolicyName: !Sub '${Project}-${Environment}-codepipeline-service'
      PolicyDocument:
        Statement:
          - Sid: PassRoleSpecificServices
            Action:
              - iam:PassRole
            Effect: Allow
            Resource: ['*']
            Condition:
              StringEqualsIfExists:
                iam:PassedToService:
                  - cloudformation.amazonaws.com
                  - ec2.amazonaws.com
                  - ecs-tasks.amazonaws.com
                  - elasticbeanstalk.amazonaws.com
          - Sid: CodeCommitLimitedAccess
            Action:
              - codecommit:CancelUploadArchive
              - codecommit:GetBranch
              - codecommit:GetCommit
              - codecommit:GetUploadArchiveStatus
              - codecommit:UploadArchive
            Effect: Allow
            Resource: ['*']
          - Sid: CodeDeployLimitedAccess
            Action:
              - codedeploy:CreateDeployment
              - codedeploy:GetApplication
              - codedeploy:GetApplicationRevision
              - codedeploy:GetDeployment
              - codedeploy:GetDeploymentConfig
              - codedeploy:RegisterApplicationRevision
            Effect: Allow
            Resource: ['*']
          - Sid: CodeStarLimitedAccess
            Action:
              - codestar-connections:UseConnection
            Effect: Allow
            Resource: ['*']
          - Sid: FullAccessSpecificServices
            Action:
              - autoscaling:*
              - cloudformation:*
              - cloudwatch:*
              - ec2:*
              - ecs:*
              - elasticbeanstalk:*
              - elasticloadbalancing:*
              - rds:*
              - s3:*
              - sns:*
              - sqs:*
            Effect: Allow
            Resource: ['*']
          - Sid: LambdaLimitedAccess
            Action:
              - lambda:InvokeFunction
              - lambda:ListFunctions
            Effect: Allow
            Resource: ['*']
          - Sid: OpsWorksLimitedAccess
            Action:
              - opsworks:CreateDeployment
              - opsworks:DescribeApps
              - opsworks:DescribeCommands
              - opsworks:DescribeDeployments
              - opsworks:DescribeInstances
              - opsworks:DescribeStacks
              - opsworks:UpdateApp
              - opsworks:UpdateStack
            Effect: Allow
            Resource: ['*']
          - Sid: CodeBuildLimitedAccess
            Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
            Effect: Allow
            Resource: ['*']
          - Sid: EcrLimitedAccess
            Action:
              - ecr:DescribeImages
            Effect: Allow
            Resource: ['*']
          - Sid: DeviceFormLimitedAccess
            Action:
              - devicefarm:CreateUpload
              - devicefarm:GetRun
              - devicefarm:GetUpload
              - devicefarm:ListDevicePools
              - devicefarm:ListProjects
              - devicefarm:ScheduleRun
            Effect: Allow
            Resource: ['*']
          - Sid: ServiceCatalogLimitedAccess
            Action:
              - servicecatalog:CreateProvisioningArtifact
              - servicecatalog:DeleteProvisioningArtifact
              - servicecatalog:DescribeProvisioningArtifact
              - servicecatalog:ListProvisioningArtifacts
              - servicecatalog:UpdateProduct
            Effect: Allow
            Resource: ['*']
        Version: '2012-10-17'


Outputs:

  IamManagedPolicyArn:
    Description: Managed policy ARN
    Value: !Ref IamManagedPolicyCodePipeline
